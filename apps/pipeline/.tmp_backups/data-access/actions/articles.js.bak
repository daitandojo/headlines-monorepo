// packages/data-access/src/actions/articles.js (version 1.0.0)
'use server'

import dbConnect from '../dbConnect.js'
import { Article } from '@headlines/models'
import { revalidatePath } from '../revalidate.js'
import { buildQuery } from '../queryBuilder.js'

const ARTICLES_PER_PAGE = 10;

export async function deleteArticle(articleId) {
  if (!articleId) {
    return { success: false, message: 'Article ID is required.' }
  }
  try {
    await dbConnect()
    const result = await Article.findByIdAndDelete(articleId)
    if (!result) return { success: false, message: 'Article not found.' }
    await revalidatePath('/')
    return { success: true, message: 'Article deleted successfully.' }
  } catch (error) {
    return { success: false, message: 'Failed to delete article.' }
  }
}

const baseQuery = {
  $or: [{ relevance_article: { $gt: 25 } }, { relevance_headline: { $gt: 25 } }],
}

export async function getArticles({ page = 1, filters = {}, sort = 'date_desc' }) {
  await dbConnect()
  const { queryFilter, sortOptions } = buildQuery(Article, { filters, sort, baseQuery })
  const skipAmount = (page - 1) * ARTICLES_PER_PAGE

  const articles = await Article.find(queryFilter)
    .sort(sortOptions)
    .skip(skipAmount)
    .limit(ARTICLES_PER_PAGE)
    .lean()

  return JSON.parse(JSON.stringify(articles))
}

export async function getTotalArticleCount({ filters = {} } = {}) {
  await dbConnect()
  const { queryFilter } = buildQuery(Article, { filters, baseQuery })
  const count = await Article.countDocuments(queryFilter)
  return count
}
