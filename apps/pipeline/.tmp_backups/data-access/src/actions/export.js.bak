// packages/data-access/src/actions/export.js (version 1.0)
'use server'

import { verifyAdmin } from '@headlines/auth';

function convertToCSV(data, columns) {
    if (!data || data.length === 0) {
        return '';
    }
    
    // Use the provided column headers, or generate from the first object's keys
    const headers = columns ? columns.map(c => c.header) : Object.keys(data[0]);
    const csvRows = [headers.join(',')];

    for (const row of data) {
        const values = headers.map(header => {
            // Find the key corresponding to the header
            const column = columns ? columns.find(c => c.header === header) : { key: header };
            let value = column ? row[column.key] : '';

            // Handle nested data like contactDetails.email
            if (column && column.key.includes('.')) {
                value = column.key.split('.').reduce((o, i) => (o ? o[i] : ''), row);
            }

            if (value === null || value === undefined) {
                value = '';
            }
            
            // Handle arrays (like whyContact)
            if (Array.isArray(value)) {
                value = value.join('; ');
            }

            const stringValue = String(value);
            // Escape quotes and handle commas
            const escaped = stringValue.replace(/"/g, '""');
            if (escaped.includes(',')) {
                return `"${escaped}"`;
            }
            return escaped;
        });
        csvRows.push(values.join(','));
    }

    return csvRows.join('\n');
}


export async function exportOpportunitiesToCSV(data) {
    const { isAdmin, error } = await verifyAdmin();
    if (!isAdmin) return { success: false, error };

    try {
        const columns = [
            { header: 'Country', key: 'basedIn' },
            { header: 'City', key: 'city' },
            { header: 'Contact', key: 'reachOutTo' },
            { header: 'Wealth ($M)', key: 'likelyMMDollarWealth' },
            { header: 'Email', key: 'contactDetails.email' },
            { header: 'Reason', key: 'whyContact' },
            { header: 'Created', key: 'createdAt' },
        ];
        const csv = convertToCSV(data, columns);
        return { success: true, data: csv };
    } catch (e) {
        return { success: false, error: 'Failed to generate CSV.' };
    }
}
