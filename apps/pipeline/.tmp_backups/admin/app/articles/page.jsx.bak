// apps/admin/src/app/articles/page.jsx (version 1.1.0)
'use client'

import { PageHeader, DataTable, ConfirmationDialog } from '@headlines/ui';
import { columns } from './columns';
import { useAdminManager } from '@/hooks/use-admin-manager';
import { deleteAdminArticle, updateAdminArticle } from '@headlines/data-access';
import { toast } from 'sonner';
import { useState, useCallback } from 'react';

export default function ArticlesPage() {
    const { data, total, isLoading, searchTerm, setSearchTerm, sort, setSort, refetch, handleUpdate, handleRemove } = useAdminManager('/api/articles', 'createdAt_desc');
    const [confirmState, setConfirmState] = useState({ isOpen: false, articleId: null });

    const handleOptimisticUpdate = useCallback(async (article, updateData) => {
        handleUpdate(article._id, updateData); // Optimistic update
        const result = await updateAdminArticle(article._id, updateData);
        if (!result.success) {
            toast.error(`Update failed: ${result.error}`);
            refetch(); // Revert
        }
    }, [handleUpdate, refetch]);

    const handleDeleteClick = (articleId) => {
        setConfirmState({ isOpen: true, articleId });
    };

    const confirmDelete = async () => {
        const { articleId } = confirmState;
        handleRemove(articleId); // Optimistic remove
        setConfirmState({ isOpen: false, articleId: null });
        const result = await deleteAdminArticle(articleId);
        if (!result.success) {
            toast.error(`Deletion failed: ${result.error}`);
            refetch(); // Revert
        } else {
            toast.success('Article deleted.');
        }
    };
    
    return (
        <div className="flex flex-col h-full">
            <PageHeader title="Article Management" description={`Review and manage all ${total.toLocaleString()} raw articles scraped by the pipeline.`} />
            <div className="mt-8 flex-grow min-h-0">
                <DataTable
                    columns={columns(handleOptimisticUpdate, handleDeleteClick)}
                    data={data}
                    isLoading={isLoading}
                    filterColumn="headline"
                    filterPlaceholder="Filter by headline, source..."
                    // Pass sort state and setter to DataTable
                    initialSort={[{id: sort.split('_')[0], desc: sort.endsWith('desc')}]}
                    onSortingChange={(updater) => {
                        const newSort = updater([{id: sort.split('_')[0], desc: sort.endsWith('desc')}]);
                        if (newSort && newSort[0]) {
                             setSort(`${newSort[0].id}_${newSort[0].desc ? 'desc' : 'asc'}`);
                        }
                    }}
                />
            </div>
            <ConfirmationDialog
                open={confirmState.isOpen}
                onOpenChange={(isOpen) => setConfirmState({ ...confirmState, isOpen })}
                onConfirm={confirmDelete}
                title="Delete Article"
                description="Are you sure you want to permanently delete this article? This action cannot be undone."
                confirmText="Delete"
             />
        </div>
    );
}
