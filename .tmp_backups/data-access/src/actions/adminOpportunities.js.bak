// packages/data-access/src/actions/adminOpportunities.js (version 1.0.0)
'use server'

import dbConnect from '../dbConnect.js'
import { Opportunity } from '@headlines/models'
import { buildQuery } from '../queryBuilder.js'
import { verifyAdmin } from '@headlines/auth'
import { revalidatePath } from '../revalidate.js'

// DEFINITIVE FIX: The hardcoded page limit has been removed entirely.
export async function getAdminOpportunities({
  page = 1,
  filters = {},
  sort = 'date_desc',
}) {
  const { isAdmin, error } = await verifyAdmin()
  if (!isAdmin) return { success: false, error, data: [], total: 0 }

  await dbConnect()
  // The query builder is still used for sorting and filtering.
  const { queryFilter, sortOptions } = await buildQuery(Opportunity, {
    filters,
    sort,
    baseQuery: {},
  })

  // Pagination logic is now removed. The action fetches all matching documents.
  const [opportunities, total] = await Promise.all([
    Opportunity.find(queryFilter)
      .populate({ path: 'events', select: 'synthesized_headline', options: { limit: 1 } })
      .sort(sortOptions)
      .lean(),
    Opportunity.countDocuments(queryFilter),
  ])

  // The total from countDocuments is still returned for the UI's information.
  return { success: true, data: JSON.parse(JSON.stringify(opportunities)), total }
}

export async function updateAdminOpportunity(oppId, updateData) {
  const { isAdmin, error } = await verifyAdmin()
  if (!isAdmin) return { success: false, error }
  try {
    await dbConnect()
    const opp = await Opportunity.findByIdAndUpdate(
      oppId,
      { $set: updateData },
      { new: true }
    ).lean()
    if (!opp) return { success: false, error: 'Opportunity not found.' }
    await revalidatePath('/admin/opportunities')
    return { success: true, data: JSON.parse(JSON.stringify(opp)) }
  } catch (e) {
    return { success: false, error: 'Failed to update opportunity.' }
  }
}

export async function deleteAdminOpportunity(oppId) {
  const { isAdmin, error } = await verifyAdmin()
  if (!isAdmin) return { success: false, error }
  try {
    await dbConnect()
    const result = await Opportunity.findByIdAndDelete(oppId)
    if (!result) return { success: false, error: 'Opportunity not found.' }
    await revalidatePath('/admin/opportunities')
    return { success: true }
  } catch (e) {
    return { success: false, error: 'Failed to delete opportunity.' }
  }
}
